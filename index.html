<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HTML Visual Editor Ultimate - çµ±åˆå®Œå…¨ç‰ˆ</title>
  <style>
    :root { 
      color-scheme: dark; 
      --primary: #18212d;
      --border: rgba(255,255,255,.08);
      --border-light: rgba(255,255,255,.12);
      --text: #e8eef7;
      --text-dim: rgba(232, 238, 247, 0.85);
      --bg: #0b0f14;
      --success: #bfffd1;
      --warning: #ffdd99;
      --danger: #ffb3b3;
      --info: #99ccff;
      --accent: rgba(0, 200, 255, .85);
      --purple: #7c3aed;
    }

    * {
      box-sizing: border-box;
    }

    body { 
      margin: 0; 
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Noto Sans JP', sans-serif; 
      background: var(--bg); 
      color: var(--text); 
    }

    header {
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      background: rgba(10, 14, 22, .75);
      backdrop-filter: blur(6px);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header .title {
      font-weight: 700;
      letter-spacing: .2px;
      background: linear-gradient(135deg, var(--accent), var(--purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .main-container {
      display: grid;
      grid-template-columns: 420px 1fr;
      height: calc(100vh - 60px);
    }

    .sidebar {
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      background: linear-gradient(180deg, rgba(18,25,38,.5), rgba(11,15,20,.5));
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      background: rgba(255,255,255,.02);
    }

    .tab {
      flex: 1;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      border: none;
      background: transparent;
      color: var(--text-dim);
      font-size: 13px;
      position: relative;
      transition: all 0.2s;
    }

    .tab:hover {
      background: rgba(255,255,255,.03);
    }

    .tab.active {
      color: var(--text);
      background: var(--primary);
    }

    .tab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--accent);
    }

    .panels {
      flex: 1;
      overflow: hidden;
      position: relative;
    }

    .panel {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 14px;
      overflow-y: auto;
      display: none;
    }

    .panel.active {
      display: block;
    }

    .panel h2 {
      font-size: 14px;
      margin: 0 0 12px;
      opacity: .9;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }

    .row label {
      min-width: 60px;
      opacity: .85;
      font-size: 13px;
    }

    input[type="range"] {
      flex: 1;
    }

    input[type="color"] {
      width: 46px;
      height: 34px;
      border: none;
      background: transparent;
      padding: 0;
      cursor: pointer;
    }

    select, input[type="text"], input[type="number"] {
      flex: 1;
      background: #101822;
      color: var(--text);
      border: 1px solid var(--border-light);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 13px;
    }

    select:focus, input[type="text"]:focus, input[type="number"]:focus {
      border-color: var(--accent);
      outline: none;
    }

    .btn {
      background: var(--primary);
      border: 1px solid var(--border-light);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .btn:hover:not(:disabled) {
      background: rgba(24, 33, 45, 0.7);
      border-color: rgba(255,255,255,.2);
    }

    .btn:disabled {
      opacity: .45;
      cursor: not-allowed;
    }

    .btn.primary {
      background: rgba(0, 200, 255, .15);
      border-color: var(--accent);
    }

    .btn.primary:hover:not(:disabled) {
      background: rgba(0, 200, 255, .25);
    }

    .btn.danger {
      border-color: rgba(239, 68, 68, .5);
    }

    .btn.small {
      padding: 6px 10px;
      font-size: 12px;
    }

    .mono {
      font-family: ui-monospace, 'SF Mono', 'Monaco', 'Cascadia Code', 'Roboto Mono', monospace;
      font-size: 12px;
    }

    .swatch {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      border: 1px solid var(--border-light);
      box-shadow: 0 6px 24px rgba(0,0,0,.35);
    }

    .viewer {
      width: 100%;
      height: 100%;
      border: 0;
      background: #fff;
    }

    .hint {
      opacity: .75;
      font-size: 12px;
      line-height: 1.4;
      margin-top: 12px;
      padding: 10px;
      background: rgba(255,255,255,.03);
      border-radius: 8px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border: 1px solid var(--border-light);
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      font-size: 12px;
    }

    .status-bar {
      padding: 8px 14px;
      background: rgba(255,255,255,.02);
      border-top: 1px solid var(--border);
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--border-light);
    }

    .indicator.active {
      background: var(--success);
    }

    /* Glow toggle */
    .toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border: 1px solid var(--border-light);
      border-radius: 999px;
      background: #0b1020;
      color: var(--text-dim);
      cursor: pointer;
      user-select: none;
      font-size: 12px;
    }

    .toggle input {
      display: none;
    }

    .toggle .dot {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 1px solid #405079;
      background: #0a0f1f;
      position: relative;
      box-shadow: inset 0 0 0 2px rgba(0,0,0,.25);
    }

    .toggle.on {
      color: var(--text);
      border-color: var(--purple);
    }

    .toggle.on .dot {
      border-color: var(--purple);
      background: rgba(124,58,237,.35);
      box-shadow: 0 0 12px rgba(124,58,237,.45);
    }

    .selected-info {
      padding: 10px;
      background: rgba(0,0,0,.2);
      border-radius: 8px;
      font-size: 12px;
      margin-bottom: 12px;
    }

    .selected-info b {
      color: var(--accent);
    }

    /* Colors for status messages */
    .ok { color: var(--success); }
    .warn { color: var(--warning); }
    .danger { color: var(--danger); }
    .info { color: var(--info); }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .main-container {
        grid-template-columns: 1fr;
      }
      
      .sidebar {
        border-right: none;
        border-bottom: 1px solid var(--border);
        height: 300px;
      }
    }

    /* Animations for UI feedback */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .loading {
      animation: pulse 1.5s infinite;
    }

    /* Custom scrollbar */
    .panel::-webkit-scrollbar {
      width: 8px;
    }

    .panel::-webkit-scrollbar-track {
      background: rgba(255,255,255,.02);
    }

    .panel::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,.1);
      border-radius: 4px;
    }

    .panel::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,.15);
    }

    /* Icon styles */
    .icon {
      width: 16px;
      height: 16px;
      opacity: 0.8;
    }

    input[type="file"] {
      display: none;
    }
  </style>
</head>
<body>
  <header>
    <div class="title">HTML Visual Editor Ultimate</div>
    <span class="pill" id="statusPill">æœªèª­ã¿è¾¼ã¿</span>
    <span style="flex:1"></span>
    <label class="btn small">
      <span>ğŸ“ HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã</span>
      <input type="file" id="fileInput" accept=".html,.htm,text/html" />
    </label>
    <button class="btn primary small" id="exportBtn" disabled>ğŸ’¾ å¤‰æ›´ã‚’ä¿å­˜</button>
  </header>

  <div class="main-container">
    <div class="sidebar">
      <div class="tabs">
        <button class="tab active" data-panel="background">èƒŒæ™¯</button>
        <button class="tab" data-panel="text">ãƒ†ã‚­ã‚¹ãƒˆ</button>
        <button class="tab" data-panel="border">æ ç·š</button>
        <button class="tab" data-panel="glow">ç™ºå…‰</button>
        <button class="tab" data-panel="animation">ã‚¢ãƒ‹ãƒ¡</button>
      </div>
      
      <div class="panels">
        <!-- Background Panel -->
        <div class="panel active" id="backgroundPanel">
          <h2>ğŸ¨ èƒŒæ™¯è‰²ã®è¨­å®š</h2>
          
          <div class="row">
            <label>èµ¤ (R)</label>
            <input type="range" id="bgR" min="0" max="255" value="255" />
            <span class="mono" id="bgRV">255</span>
          </div>
          
          <div class="row">
            <label>ç·‘ (G)</label>
            <input type="range" id="bgG" min="0" max="255" value="255" />
            <span class="mono" id="bgGV">255</span>
          </div>
          
          <div class="row">
            <label>é’ (B)</label>
            <input type="range" id="bgB" min="0" max="255" value="255" />
            <span class="mono" id="bgBV">255</span>
          </div>
          
          <div class="row">
            <label>ä¸é€æ˜åº¦</label>
            <input type="range" id="bgA" min="0" max="100" value="100" />
            <span class="mono" id="bgAV">100%</span>
          </div>
          
          <div class="row">
            <div class="swatch" id="bgSwatch"></div>
            <button class="btn small" id="bgPickBtn">ã‚«ãƒ©ãƒ¼é¸æŠ</button>
            <input type="color" id="bgColorPick" style="display:none" />
          </div>
          
          <div class="hint">
            èƒŒæ™¯è‰²ã¯HTMLå…¨ä½“ã«é©ç”¨ã•ã‚Œã¾ã™ã€‚è‡ªå‹•æ¤œå‡ºæ©Ÿèƒ½ã«ã‚ˆã‚Šã€æ—¢å­˜ã®èƒŒæ™¯è‰²ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚
          </div>
        </div>

        <!-- Text Panel -->
        <div class="panel" id="textPanel">
          <h2>âœï¸ ãƒ†ã‚­ã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ«</h2>
          
          <div class="selected-info" id="textSelectedInfo">
            è¦ç´ ã‚’é¸æŠã—ã¦ãã ã•ã„
          </div>
          
          <div class="row">
            <label>ãƒ†ã‚­ã‚¹ãƒˆè‰²</label>
            <input type="color" id="textColor" value="#000000" />
            <span class="mono" id="textHex">#000000</span>
          </div>
          
          <div class="row">
            <label>ä¸é€æ˜åº¦</label>
            <input type="range" id="textAlpha" min="0" max="100" value="100" />
            <span class="mono" id="textAlphaV">1.00</span>
          </div>
          
          <div class="row">
            <label>ã‚µã‚¤ã‚º</label>
            <input type="range" id="textSize" min="8" max="72" value="16" />
            <span class="mono" id="textSizeV">16px</span>
          </div>
          
          <div class="row">
            <button class="btn small" id="textReset">ãƒªã‚»ãƒƒãƒˆ</button>
            <button class="btn small" id="textClear">é¸æŠè§£é™¤</button>
          </div>
          
          <div class="hint">
            è¦ç´ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ†ã‚­ã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¾ã™ã€‚å¤‰æ›´ã¯styleå±æ€§ã«ç›´æ¥æ›¸ãè¾¼ã¾ã‚Œã¾ã™ã€‚
          </div>
        </div>

        <!-- Border Panel -->
        <div class="panel" id="borderPanel">
          <h2>ğŸ”² æ ç·šè¨­å®š</h2>
          
          <div class="selected-info" id="borderSelectedInfo">
            è¦ç´ ã‚’é¸æŠã—ã¦ãã ã•ã„
          </div>
          
          <div class="row">
            <label>å¤ªã•(px)</label>
            <input type="number" id="borderWidth" min="0" value="2" />
          </div>
          
          <div class="row">
            <label>è‰²</label>
            <input type="color" id="borderColor" value="#7c3aed" />
          </div>
          
          <div class="row">
            <label>ç¨®é¡</label>
            <select id="borderStyle">
              <option value="solid">solid</option>
              <option value="dashed">dashed</option>
              <option value="dotted">dotted</option>
              <option value="double">double</option>
              <option value="none">none</option>
            </select>
          </div>
          
          <div class="row">
            <button class="btn small" id="applyBorderBtn" disabled>æ ç·šã‚’é©ç”¨</button>
            <button class="btn danger small" id="removeBorderBtn" disabled>æ ç·šã‚’å‰Šé™¤</button>
          </div>
          
          <div class="hint">
            è¦ç´ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ ç·šã‚’è¨­å®šã—ã¾ã™ã€‚é©ç”¨ã¯styleå±æ€§ã¸æ›¸ãè¾¼ã¿ã¾ã™ã€‚
          </div>
        </div>

        <!-- Glow Panel -->
        <div class="panel" id="glowPanel">
          <h2>âœ¨ ç™ºå…‰åŠ¹æœ (box-shadow)</h2>
          
          <div class="selected-info" id="glowSelectedInfo">
            è¦ç´ ã‚’é¸æŠã—ã¦ãã ã•ã„
          </div>
          
          <div class="row">
            <div class="toggle" id="glowToggle">
              <span class="dot"></span>
              <span id="glowLabel">ç™ºå…‰ OFF</span>
              <input type="checkbox" id="glowOn" />
            </div>
          </div>
          
          <div class="row">
            <label>ç™ºå…‰è‰²</label>
            <input type="color" id="glowColor" value="#7c3aed" />
          </div>
          
          <div class="row">
            <label>ã¼ã‹ã—</label>
            <input type="range" id="glowBlur" min="0" max="50" value="20" />
            <span class="mono" id="glowBlurV">20px</span>
          </div>
          
          <div class="row">
            <button class="btn small" id="applyGlowBtn" disabled>ç™ºå…‰ã‚’é©ç”¨</button>
          </div>
          
          <div class="hint">
            ONæ™‚ã¯box-shadowã‚’é©ç”¨ã—ã¾ã™ã€‚OFFã§noneã«ã—ã¾ã™ã€‚<br/>
            OFFã«ã™ã‚‹å‰ã®å€¤ã¯è¦ç´ ã«é€€é¿ã—ã€ONã§å¾©å…ƒã§ãã¾ã™ã€‚
          </div>
        </div>

        <!-- Animation Panel -->
        <div class="panel" id="animationPanel">
          <h2>ğŸ­ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š</h2>
          
          <div class="selected-info" id="animSelectedInfo">
            è¦ç´ ã‚’é¸æŠã—ã¦ãã ã•ã„
          </div>
          
          <div class="row">
            <label>ãƒ—ãƒªã‚»ãƒƒãƒˆ</label>
            <select id="animPreset">
              <option value="none">ãªã—</option>
              <option value="fade-in">ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³</option>
              <option value="slide-up">ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¢ãƒƒãƒ—</option>
              <option value="slide-down">ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ€ã‚¦ãƒ³</option>
              <option value="slide-left">ã‚¹ãƒ©ã‚¤ãƒ‰å·¦</option>
              <option value="slide-right">ã‚¹ãƒ©ã‚¤ãƒ‰å³</option>
              <option value="zoom-in">ã‚ºãƒ¼ãƒ ã‚¤ãƒ³</option>
              <option value="zoom-out">ã‚ºãƒ¼ãƒ ã‚¢ã‚¦ãƒˆ</option>
              <option value="rotate">å›è»¢</option>
              <option value="bounce">ãƒã‚¦ãƒ³ã‚¹</option>
              <option value="pulse">ãƒ‘ãƒ«ã‚¹</option>
              <option value="shake">ã‚·ã‚§ã‚¤ã‚¯</option>
            </select>
          </div>
          
          <div class="row">
            <label>æ™‚é–“</label>
            <input type="range" id="animDur" min="0.1" max="5" step="0.1" value="0.8" />
            <span class="mono" id="animDurV">0.80s</span>
          </div>
          
          <div class="row">
            <label>é…å»¶</label>
            <input type="range" id="animDelay" min="0" max="5" step="0.1" value="0" />
            <span class="mono" id="animDelayV">0.00s</span>
          </div>
          
          <div class="row">
            <label>ã‚¤ãƒ¼ã‚¸ãƒ³ã‚°</label>
            <select id="animEase">
              <option value="linear">linear</option>
              <option value="ease" selected>ease</option>
              <option value="ease-in">ease-in</option>
              <option value="ease-out">ease-out</option>
              <option value="ease-in-out">ease-in-out</option>
            </select>
          </div>
          
          <div class="row">
            <label>ç¹°ã‚Šè¿”ã—</label>
            <select id="animIter">
              <option value="1">1å›</option>
              <option value="2">2å›</option>
              <option value="3">3å›</option>
              <option value="infinite">ç„¡é™</option>
            </select>
          </div>
          
          <div class="row">
            <button class="btn small" id="animReplay">å†ç”Ÿ</button>
            <button class="btn small" id="animReset">ãƒªã‚»ãƒƒãƒˆ</button>
            <button class="btn small" id="animClear">é¸æŠè§£é™¤</button>
          </div>
          
          <div class="hint">
            è¦ç´ ã‚’é¸æŠã—ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¨­å®šã—ã¾ã™ã€‚ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§å‹•ä½œã‚’ç¢ºèªã§ãã¾ã™ã€‚
          </div>
        </div>
      </div>
    </div>
    
    <main>
      <iframe class="viewer" id="iframe"></iframe>
    </main>
  </div>

  <div class="status-bar">
    <span class="status-item">
      <span class="indicator" id="statusIndicator"></span>
      <span id="statusText">æº–å‚™å®Œäº†</span>
    </span>
    <span class="status-item">
      <span id="statusSelection">é¸æŠ: ãªã—</span>
    </span>
  </div>

  <script>
    // ===== Elements =====
    const fileInput = document.getElementById('fileInput');
    const exportBtn = document.getElementById('exportBtn');
    const iframe = document.getElementById('iframe');
    const statusPill = document.getElementById('statusPill');
    const statusText = document.getElementById('statusText');
    const statusSelection = document.getElementById('statusSelection');
    const statusIndicator = document.getElementById('statusIndicator');
    
    // Background elements
    const bgR = document.getElementById('bgR');
    const bgG = document.getElementById('bgG');
    const bgB = document.getElementById('bgB');
    const bgA = document.getElementById('bgA');
    const bgRV = document.getElementById('bgRV');
    const bgGV = document.getElementById('bgGV');
    const bgBV = document.getElementById('bgBV');
    const bgAV = document.getElementById('bgAV');
    const bgSwatch = document.getElementById('bgSwatch');
    const bgPickBtn = document.getElementById('bgPickBtn');
    const bgColorPick = document.getElementById('bgColorPick');
    
    // Text elements
    const textSelectedInfo = document.getElementById('textSelectedInfo');
    const textColor = document.getElementById('textColor');
    const textHex = document.getElementById('textHex');
    const textAlpha = document.getElementById('textAlpha');
    const textAlphaV = document.getElementById('textAlphaV');
    const textSize = document.getElementById('textSize');
    const textSizeV = document.getElementById('textSizeV');
    const textReset = document.getElementById('textReset');
    const textClear = document.getElementById('textClear');
    
    // Border elements
    const borderSelectedInfo = document.getElementById('borderSelectedInfo');
    const borderWidth = document.getElementById('borderWidth');
    const borderColor = document.getElementById('borderColor');
    const borderStyle = document.getElementById('borderStyle');
    const applyBorderBtn = document.getElementById('applyBorderBtn');
    const removeBorderBtn = document.getElementById('removeBorderBtn');
    
    // Glow elements
    const glowSelectedInfo = document.getElementById('glowSelectedInfo');
    const glowToggle = document.getElementById('glowToggle');
    const glowLabel = document.getElementById('glowLabel');
    const glowOn = document.getElementById('glowOn');
    const glowColor = document.getElementById('glowColor');
    const glowBlur = document.getElementById('glowBlur');
    const glowBlurV = document.getElementById('glowBlurV');
    const applyGlowBtn = document.getElementById('applyGlowBtn');
    
    // Animation elements
    const animSelectedInfo = document.getElementById('animSelectedInfo');
    const animPreset = document.getElementById('animPreset');
    const animDur = document.getElementById('animDur');
    const animDurV = document.getElementById('animDurV');
    const animDelay = document.getElementById('animDelay');
    const animDelayV = document.getElementById('animDelayV');
    const animEase = document.getElementById('animEase');
    const animIter = document.getElementById('animIter');
    const animReplay = document.getElementById('animReplay');
    const animReset = document.getElementById('animReset');
    const animClear = document.getElementById('animClear');
    
    // ===== State =====
    let currentPanel = 'background';
    let selectedElement = null;
    let originalHtml = '';
    let lastFilename = 'edited.html';
    
    // ===== Tab Switching =====
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const panel = tab.dataset.panel;
        
        // Update active tab
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Update active panel
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.getElementById(panel + 'Panel').classList.add('active');
        
        currentPanel = panel;
        
        // Clear selection when switching tabs
        if (currentPanel === 'background') {
          clearAllSelections();
        }
      });
    });
    
    // ===== Helper Functions =====
    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
    
    function parseColorToRGBA(color) {
      const div = document.createElement('div');
      div.style.color = color;
      document.body.appendChild(div);
      const computed = getComputedStyle(div).color;
      document.body.removeChild(div);
      
      const match = computed.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*([\d.]+))?\)/);
      if (!match) return null;
      
      return {
        R: parseInt(match[1], 10),
        G: parseInt(match[2], 10),
        B: parseInt(match[3], 10),
        A: match[4] ? parseFloat(match[4]) : 1
      };
    }
    
    function detectBackgroundColor(html) {
      const bodyMatch = html.match(/<body[^>]*style\s*=\s*["']([^"']*)/i);
      if (!bodyMatch) return null;
      
      const style = bodyMatch[1];
      const bgMatch = style.match(/background(?:-color)?\s*:\s*([^;]+)/i);
      if (!bgMatch) return null;
      
      return parseColorToRGBA(bgMatch[1].trim());
    }
    
    function getCssPath(element) {
      const path = [];
      while (element && element.nodeType === Node.ELEMENT_NODE) {
        let selector = element.nodeName.toLowerCase();
        if (element.id) {
          selector += '#' + element.id;
          path.unshift(selector);
          break;
        } else {
          let sibling = element;
          let nth = 1;
          while (sibling.previousElementSibling) {
            sibling = sibling.previousElementSibling;
            if (sibling.nodeName === element.nodeName) nth++;
          }
          if (nth > 1) selector += ':nth-of-type(' + nth + ')';
        }
        path.unshift(selector);
        element = element.parentNode;
      }
      return path.join(' > ');
    }
    
    // ===== Editor Styles Injection =====
    function ensureEditorStyles(doc) {
      let style = doc.getElementById('ultimate-editor-styles');
      if (!style) {
        style = doc.createElement('style');
        style.id = 'ultimate-editor-styles';
        style.innerHTML = `
          [data-editor-selected] {
            outline: 2px solid rgba(0, 200, 255, .9) !important;
            outline-offset: 2px !important;
          }
          [data-editor-hover] {
            outline: 2px dashed rgba(0, 200, 255, .5) !important;
            outline-offset: 2px !important;
          }
        `;
        doc.head.appendChild(style);
      }
    }
    
    function ensureAnimationStyles(doc) {
      let style = doc.getElementById('ultimate-anim-styles');
      if (!style) {
        style = doc.createElement('style');
        style.id = 'ultimate-anim-styles';
        style.innerHTML = `
          @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
          }
          @keyframes slide-up {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
          }
          @keyframes slide-down {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
          }
          @keyframes slide-left {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
          @keyframes slide-right {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
          @keyframes zoom-in {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
          }
          @keyframes zoom-out {
            from { transform: scale(1.2); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
          }
          @keyframes rotate {
            from { transform: rotate(-90deg); opacity: 0; }
            to { transform: rotate(0); opacity: 1; }
          }
          @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-30px); }
            60% { transform: translateY(-15px); }
          }
          @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
          }
          @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
          }
          
          [data-ae] {
            animation-name: var(--ae-name);
            animation-duration: var(--ae-dur, 1s);
            animation-delay: var(--ae-delay, 0s);
            animation-timing-function: var(--ae-ease, ease);
            animation-iteration-count: var(--ae-iter, 1);
            animation-fill-mode: var(--ae-fill, both);
            animation-play-state: var(--ae-state, running);
          }
          
          [data-ae="fade-in"] { --ae-name: fade-in; }
          [data-ae="slide-up"] { --ae-name: slide-up; }
          [data-ae="slide-down"] { --ae-name: slide-down; }
          [data-ae="slide-left"] { --ae-name: slide-left; }
          [data-ae="slide-right"] { --ae-name: slide-right; }
          [data-ae="zoom-in"] { --ae-name: zoom-in; }
          [data-ae="zoom-out"] { --ae-name: zoom-out; }
          [data-ae="rotate"] { --ae-name: rotate; }
          [data-ae="bounce"] { --ae-name: bounce; }
          [data-ae="pulse"] { --ae-name: pulse; }
          [data-ae="shake"] { --ae-name: shake; }
        `;
        doc.head.appendChild(style);
      }
    }
    
    // ===== Background Functions =====
    function syncBackgroundUI() {
      const r = +bgR.value;
      const g = +bgG.value;
      const b = +bgB.value;
      const a = +bgA.value / 100;
      
      bgRV.textContent = r;
      bgGV.textContent = g;
      bgBV.textContent = b;
      bgAV.textContent = `${bgA.value}%`;
      
      const rgba = `rgba(${r},${g},${b},${a})`;
      bgSwatch.style.background = rgba;
      
      const doc = iframe.contentDocument;
      if (!doc) return;
      
      let style = doc.getElementById('ultimate-bg-override');
      if (!style) {
        style = doc.createElement('style');
        style.id = 'ultimate-bg-override';
        doc.head.appendChild(style);
      }
      style.innerHTML = `html, body { background: ${rgba} !important; }`;
    }
    
    // ===== Selection Management =====
    function clearAllSelections() {
      const doc = iframe.contentDocument;
      if (!doc) return;
      
      doc.querySelectorAll('[data-editor-selected]').forEach(el => {
        el.removeAttribute('data-editor-selected');
      });
      doc.querySelectorAll('[data-editor-hover]').forEach(el => {
        el.removeAttribute('data-editor-hover');
      });
      
      selectedElement = null;
      updateAllPanels(null);
    }
    
    function selectElement(element) {
      const doc = iframe.contentDocument;
      if (!doc) return;
      
      clearAllSelections();
      
      if (element) {
        selectedElement = element;
        element.setAttribute('data-editor-selected', '1');
        updateAllPanels(element);
        statusSelection.textContent = `é¸æŠ: ${element.tagName.toLowerCase()}`;
      }
    }
    
    function updateAllPanels(element) {
      updateTextPanel(element);
      updateBorderPanel(element);
      updateGlowPanel(element);
      updateAnimationPanel(element);
    }
    
    // ===== Panel Updates =====
    function updateTextPanel(element) {
      if (!element) {
        textSelectedInfo.innerHTML = 'è¦ç´ ã‚’é¸æŠã—ã¦ãã ã•ã„';
        textReset.disabled = true;
        textClear.disabled = true;
        return;
      }
      
      const tag = element.tagName.toLowerCase();
      const path = getCssPath(element);
      textSelectedInfo.innerHTML = `<b>${escapeHtml(tag)}</b><br/><span style="font-size:11px;">${escapeHtml(path)}</span>`;
      
      const cs = element.ownerDocument.defaultView.getComputedStyle(element);
      const rgba = parseColorToRGBA(cs.color);
      
      if (rgba) {
        const hex = '#' + [rgba.R, rgba.G, rgba.B].map(x => x.toString(16).padStart(2, '0')).join('');
        textColor.value = hex;
        textHex.textContent = hex.toUpperCase();
        textAlpha.value = Math.round(rgba.A * 100);
        textAlphaV.textContent = rgba.A.toFixed(2);
      }
      
      const size = parseFloat(cs.fontSize) || 16;
      textSize.value = size;
      textSizeV.textContent = `${size}px`;
      
      textReset.disabled = false;
      textClear.disabled = false;
    }
    
    function updateBorderPanel(element) {
      if (!element) {
        borderSelectedInfo.innerHTML = 'è¦ç´ ã‚’é¸æŠã—ã¦ãã ã•ã„';
        applyBorderBtn.disabled = true;
        removeBorderBtn.disabled = true;
        return;
      }
      
      const tag = element.tagName.toLowerCase();
      const path = getCssPath(element);
      borderSelectedInfo.innerHTML = `<b>${escapeHtml(tag)}</b><br/><span style="font-size:11px;">${escapeHtml(path)}</span>`;
      
      const cs = element.ownerDocument.defaultView.getComputedStyle(element);
      
      const width = parseFloat(cs.borderTopWidth) || 0;
      borderWidth.value = Math.round(width);
      
      const style = (cs.borderTopStyle && cs.borderTopStyle !== 'none') ? cs.borderTopStyle : 'solid';
      borderStyle.value = style;
      
      const rgba = parseColorToRGBA(cs.borderTopColor);
      if (rgba) {
        const hex = '#' + [rgba.R, rgba.G, rgba.B].map(x => x.toString(16).padStart(2, '0')).join('');
        borderColor.value = hex;
      }
      
      applyBorderBtn.disabled = false;
      removeBorderBtn.disabled = false;
    }
    
    function updateGlowPanel(element) {
      if (!element) {
        glowSelectedInfo.innerHTML = 'è¦ç´ ã‚’é¸æŠã—ã¦ãã ã•ã„';
        applyGlowBtn.disabled = true;
        return;
      }
      
      const tag = element.tagName.toLowerCase();
      const path = getCssPath(element);
      glowSelectedInfo.innerHTML = `<b>${escapeHtml(tag)}</b><br/><span style="font-size:11px;">${escapeHtml(path)}</span>`;
      
      const cs = element.ownerDocument.defaultView.getComputedStyle(element);
      const isGlowOn = cs.boxShadow && cs.boxShadow !== 'none';
      
      setGlowUI(isGlowOn);
      
      if (isGlowOn) {
        // Try to extract color from box-shadow
        const match = cs.boxShadow.match(/rgba?\([^)]+\)/i);
        if (match) {
          const rgba = parseColorToRGBA(match[0]);
          if (rgba) {
            const hex = '#' + [rgba.R, rgba.G, rgba.B].map(x => x.toString(16).padStart(2, '0')).join('');
            glowColor.value = hex;
          }
        }
      }
      
      applyGlowBtn.disabled = false;
    }
    
    function updateAnimationPanel(element) {
      if (!element) {
        animSelectedInfo.innerHTML = 'è¦ç´ ã‚’é¸æŠã—ã¦ãã ã•ã„';
        animPreset.disabled = true;
        animDur.disabled = true;
        animDelay.disabled = true;
        animEase.disabled = true;
        animIter.disabled = true;
        animReplay.disabled = true;
        animReset.disabled = true;
        animClear.disabled = true;
        return;
      }
      
      const tag = element.tagName.toLowerCase();
      const path = getCssPath(element);
      animSelectedInfo.innerHTML = `<b>${escapeHtml(tag)}</b><br/><span style="font-size:11px;">${escapeHtml(path)}</span>`;
      
      const ae = element.getAttribute('data-ae') || 'none';
      animPreset.value = ae;
      
      const getVar = (name, fallback) => (element.style.getPropertyValue(name) || fallback).trim();
      animDur.value = parseFloat(getVar('--ae-dur', '0.8s')) || 0.8;
      animDelay.value = parseFloat(getVar('--ae-delay', '0s')) || 0;
      animEase.value = getVar('--ae-ease', 'ease');
      animIter.value = getVar('--ae-iter', '1');
      
      syncAnimationReadouts();
      
      animPreset.disabled = false;
      animDur.disabled = false;
      animDelay.disabled = false;
      animEase.disabled = false;
      animIter.disabled = false;
      animReplay.disabled = false;
      animReset.disabled = false;
      animClear.disabled = false;
    }
    
    function syncAnimationReadouts() {
      animDurV.textContent = `${(+animDur.value).toFixed(2)}s`;
      animDelayV.textContent = `${(+animDelay.value).toFixed(2)}s`;
    }
    
    function setGlowUI(isOn) {
      glowOn.checked = !!isOn;
      glowToggle.classList.toggle('on', !!isOn);
      glowLabel.textContent = isOn ? 'ç™ºå…‰ ON' : 'ç™ºå…‰ OFF';
      glowBlurV.textContent = `${glowBlur.value}px`;
    }
    
    // ===== Apply Functions =====
    function applyTextStyles() {
      if (!selectedElement) return;
      
      const color = textColor.value;
      const alpha = (+textAlpha.value) / 100;
      const size = textSize.value;
      
      const rgba = parseColorToRGBA(color);
      if (rgba) {
        selectedElement.style.color = `rgba(${rgba.R}, ${rgba.G}, ${rgba.B}, ${alpha})`;
      }
      selectedElement.style.fontSize = `${size}px`;
      
      statusText.textContent = 'å¤‰æ›´ã‚’é©ç”¨ã—ã¾ã—ãŸ';
    }
    
    function applyBorder() {
      if (!selectedElement) return;
      
      const width = Math.max(0, parseInt(borderWidth.value || '0', 10));
      const color = borderColor.value || '#000000';
      const style = borderStyle.value || 'solid';
      
      selectedElement.style.borderWidth = width + 'px';
      selectedElement.style.borderStyle = style;
      selectedElement.style.borderColor = color;
      
      updateBorderPanel(selectedElement);
      statusText.textContent = 'æ ç·šã‚’é©ç”¨ã—ã¾ã—ãŸ';
    }
    
    function removeBorder() {
      if (!selectedElement) return;
      
      selectedElement.style.border = 'none';
      updateBorderPanel(selectedElement);
      statusText.textContent = 'æ ç·šã‚’å‰Šé™¤ã—ã¾ã—ãŸ';
    }
    
    function applyGlow() {
      if (!selectedElement) return;
      
      const isOn = glowOn.checked;
      
      if (!isOn) {
        // OFF: Save current box-shadow and clear it
        const cs = selectedElement.ownerDocument.defaultView.getComputedStyle(selectedElement);
        const current = cs.boxShadow;
        if (current && current !== 'none') {
          selectedElement.dataset.glowPrev = current;
        }
        selectedElement.style.boxShadow = 'none';
      } else {
        // ON: Restore or apply new glow
        const prev = selectedElement.dataset.glowPrev;
        if (prev && prev !== 'none') {
          selectedElement.style.boxShadow = prev;
        } else {
          const color = glowColor.value || '#7c3aed';
          const blur = glowBlur.value || 20;
          selectedElement.style.boxShadow = `0 0 ${blur}px ${color}`;
        }
      }
      
      updateGlowPanel(selectedElement);
      statusText.textContent = isOn ? 'ç™ºå…‰ã‚’é©ç”¨ã—ã¾ã—ãŸ' : 'ç™ºå…‰ã‚’è§£é™¤ã—ã¾ã—ãŸ';
    }
    
    function applyAnimation() {
      if (!selectedElement) return;
      
      const doc = iframe.contentDocument;
      if (!doc) return;
      
      ensureAnimationStyles(doc);
      
      const preset = animPreset.value;
      
      if (preset === 'none') {
        selectedElement.removeAttribute('data-ae');
        selectedElement.style.removeProperty('--ae-dur');
        selectedElement.style.removeProperty('--ae-delay');
        selectedElement.style.removeProperty('--ae-ease');
        selectedElement.style.removeProperty('--ae-iter');
        selectedElement.style.removeProperty('--ae-fill');
        selectedElement.style.removeProperty('--ae-state');
        return;
      }
      
      selectedElement.setAttribute('data-ae', preset);
      selectedElement.style.setProperty('--ae-dur', `${(+animDur.value).toFixed(2)}s`);
      selectedElement.style.setProperty('--ae-delay', `${(+animDelay.value).toFixed(2)}s`);
      selectedElement.style.setProperty('--ae-ease', animEase.value);
      selectedElement.style.setProperty('--ae-iter', animIter.value);
      selectedElement.style.setProperty('--ae-fill', 'both');
      
      statusText.textContent = 'ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¨­å®šã—ã¾ã—ãŸ';
    }
    
    function replayAnimation() {
      if (!selectedElement) return;
      selectedElement.style.setProperty('--ae-state', 'paused');
      void selectedElement.offsetWidth;
      selectedElement.style.removeProperty('--ae-state');
      statusText.textContent = 'ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†ç”Ÿã—ã¾ã—ãŸ';
    }
    
    // ===== Document Interaction =====
    function attachDocumentListeners(doc) {
      ensureEditorStyles(doc);
      ensureAnimationStyles(doc);
      
      const onClick = (e) => {
        if (currentPanel === 'background') return;
        
        e.preventDefault();
        e.stopPropagation();
        
        const target = e.target;
        if (target && target.nodeType === Node.ELEMENT_NODE) {
          selectElement(target);
        }
      };
      
      const onMove = (e) => {
        if (currentPanel === 'background') return;
        
        const doc = iframe.contentDocument;
        if (!doc) return;
        
        doc.querySelectorAll('[data-editor-hover]').forEach(el => {
          el.removeAttribute('data-editor-hover');
        });
        
        const target = e.target;
        if (target && target.nodeType === Node.ELEMENT_NODE && target !== selectedElement) {
          target.setAttribute('data-editor-hover', '1');
        }
      };
      
      doc.addEventListener('click', onClick, true);
      doc.addEventListener('mousemove', onMove, true);
    }
    
    // ===== Export Function =====
    function exportHtml() {
      const doc = iframe.contentDocument;
      if (!doc) return;
      
      // Clean up editor markers
      doc.querySelectorAll('[data-editor-selected]').forEach(el => {
        el.removeAttribute('data-editor-selected');
      });
      doc.querySelectorAll('[data-editor-hover]').forEach(el => {
        el.removeAttribute('data-editor-hover');
      });
      
      // Remove editor styles
      const editorStyle = doc.getElementById('ultimate-editor-styles');
      if (editorStyle) editorStyle.remove();
      
      // Build final HTML
      const doctype = '<!doctype html>\n';
      let html = doctype + doc.documentElement.outerHTML;
      
      // Download
      const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = lastFilename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      
      // Restore editor UI
      ensureEditorStyles(doc);
      if (selectedElement) {
        selectedElement.setAttribute('data-editor-selected', '1');
      }
      
      statusText.innerHTML = '<span class="ok">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†ï¼</span>';
      setTimeout(() => {
        statusText.textContent = 'ç·¨é›†ä¸­...';
      }, 2000);
    }
    
    // ===== Event Listeners =====
    
    // File input
    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      
      lastFilename = file.name.replace(/\.(html?|HTML?)$/, '') + '_edited.html';
      originalHtml = await file.text();
      
      iframe.srcdoc = originalHtml;
      exportBtn.disabled = false;
      
      // Detect background color
      const detected = detectBackgroundColor(originalHtml);
      if (detected) {
        bgR.value = detected.R;
        bgG.value = detected.G;
        bgB.value = detected.B;
        bgA.value = Math.round(detected.A * 100);
        syncBackgroundUI();
        statusText.innerHTML = '<span class="ok">èƒŒæ™¯è‰²ã‚’æ¤œå‡ºã—ã¾ã—ãŸ</span>';
      } else {
        syncBackgroundUI();
      }
      
      // Setup iframe
      iframe.addEventListener('load', () => {
        const doc = iframe.contentDocument;
        attachDocumentListeners(doc);
        syncBackgroundUI();
        statusIndicator.classList.add('active');
        statusPill.textContent = 'ç·¨é›†ä¸­';
        setTimeout(() => {
          statusText.textContent = 'ç·¨é›†ä¸­...';
        }, 2000);
      }, { once: true });
    });
    
    // Background controls
    [bgR, bgG, bgB, bgA].forEach(inp => inp.addEventListener('input', syncBackgroundUI));
    bgPickBtn.addEventListener('click', () => bgColorPick.click());
    bgColorPick.addEventListener('input', () => {
      const rgba = parseColorToRGBA(bgColorPick.value);
      if (rgba) {
        bgR.value = rgba.R;
        bgG.value = rgba.G;
        bgB.value = rgba.B;
        syncBackgroundUI();
      }
    });
    
    // Text controls
    function onTextUIChange() {
      textHex.textContent = textColor.value.toUpperCase();
      const a = (+textAlpha.value) / 100;
      textAlphaV.textContent = a.toFixed(2);
      textSizeV.textContent = `${textSize.value}px`;
      applyTextStyles();
    }
    
    textColor.addEventListener('input', onTextUIChange);
    textAlpha.addEventListener('input', onTextUIChange);
    textSize.addEventListener('input', onTextUIChange);
    
    textReset.addEventListener('click', () => {
      if (!selectedElement) return;
      selectedElement.style.removeProperty('color');
      selectedElement.style.removeProperty('font-size');
      updateTextPanel(selectedElement);
      statusText.textContent = 'ãƒ†ã‚­ã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ';
    });
    
    textClear.addEventListener('click', () => {
      clearAllSelections();
      statusSelection.textContent = 'é¸æŠ: ãªã—';
    });
    
    // Border controls
    applyBorderBtn.addEventListener('click', applyBorder);
    removeBorderBtn.addEventListener('click', removeBorder);
    
    // Glow controls
    glowToggle.addEventListener('click', () => {
      if (!selectedElement) return;
      glowOn.checked = !glowOn.checked;
      setGlowUI(glowOn.checked);
    });
    
    glowBlur.addEventListener('input', () => {
      glowBlurV.textContent = `${glowBlur.value}px`;
    });
    
    applyGlowBtn.addEventListener('click', applyGlow);
    
    // Animation controls
    function onAnimUIChange() {
      syncAnimationReadouts();
      applyAnimation();
      replayAnimation();
    }
    
    [animPreset, animDur, animDelay, animEase, animIter].forEach(inp => {
      inp.addEventListener('input', onAnimUIChange);
    });
    
    animReplay.addEventListener('click', replayAnimation);
    
    animReset.addEventListener('click', () => {
      if (!selectedElement) return;
      selectedElement.removeAttribute('data-ae');
      ['--ae-dur', '--ae-delay', '--ae-ease', '--ae-iter', '--ae-fill', '--ae-state'].forEach(prop => {
        selectedElement.style.removeProperty(prop);
      });
      updateAnimationPanel(selectedElement);
      statusText.textContent = 'ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ';
    });
    
    animClear.addEventListener('click', () => {
      clearAllSelections();
      statusSelection.textContent = 'é¸æŠ: ãªã—';
    });
    
    // Export
    exportBtn.addEventListener('click', exportHtml);
    
    // ===== Initialize =====
    syncBackgroundUI();
    setGlowUI(false);
    syncAnimationReadouts();
    
    // Load default preview
    iframe.srcdoc = `<!doctype html>
<html>
<head>
  <meta charset='utf-8'>
  <title>Preview</title>
  <style>
    body {
      margin: 0;
      min-height: 100vh;
      display: grid;
      place-items: center;
      font-family: system-ui;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .welcome {
      text-align: center;
      animation: fadeIn 1s ease-out;
    }
    .welcome h1 {
      font-size: 3em;
      margin-bottom: 0.5em;
    }
    .welcome p {
      font-size: 1.2em;
      opacity: 0.9;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="welcome">
    <h1>HTML Visual Editor Ultimate</h1>
    <p>HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ç·¨é›†ã‚’é–‹å§‹ã—ã¦ãã ã•ã„</p>
  </div>
</body>
</html>`;
  </script>
</body>
</html>
